{% set version = "2.6.1" %}

package:
  name: libprotobuf
  version: {{ version }}

source:
  # https://github.com/protocolbuffers/protobuf/releases/tag/v2.6.1
  # These assets come in different archives with three different contents
  # DIST: protobuf-2.6.1.tar.bz2 == protobuf-2.6.1.zip
  # RAW: protobuf-2.6.1.tar.gz == Source code (zip) == Source code (tar.gz)
  # PROTOC: protoc-2.6.1-win32.zip
  #
  # DIST appears to be the same as RAW but processed-for-distribution.
  # PROTOC contains a version of `protoc` built for windows 10.
  - url: https://github.com/protocolbuffers/protobuf/releases/download/v{{ version }}/protobuf-{{ version }}.tar.gz  # [not win]
    sha256: 2667b7cda4a6bc8a09e5463adf3b5984e08d94e72338277affa8594d8b6e5cd1  # [not win]
  - url: https://github.com/protocolbuffers/protobuf/releases/download/v{{ version }}/protobuf-{{ version }}.zip  # [win]
    sha256: 146362958DB8C07A3459E81EDF3C3B73EC81B26E54293EC7340E510BBB930504  # [win]
  - url: https://github.com/protocolbuffers/protobuf/releases/download/v{{ version }}/protoc-{{ version }}-win32.zip  # [win]
    sha256: EBCE7083B4A50AA94C0C62238FF56F658E99A5D87FCC5BAD33EA665DBFC7793D  # [win]

build:
  number: 0
  skip: True  # [win]

outputs:
  - name: libprotobuf
    script: build-shared.sh  # [unix]
    script: bld-shared.bat  # [win]
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - cmake  # [win]
        - ninja  # [win]
        - autoconf  # [not win]
        - automake  # [not win]
        - libtool  # [not win]
        - pkg-config  # [not win]
        - unzip  # [not win]
        - make  # [not win]
        - gtest  # [not win]
      host:
        - zlib
      run:
        - zlib
    test:
      commands:
        - protoc --help
        - test -f ${PREFIX}/lib/libprotobuf${SHLIB_EXT}  # [not win]
        - test ! -f ${PREFIX}/lib/libprotobuf.a  # [not win]
        - if not exist %PREFIX%\\Library\\lib\\libprotoc.lib exit 1  # [win]
        - if not exist %PREFIX%\\Library\\lib\\libprotobuf.lib exit 1  # [win]
        - if not exist %PREFIX%\\Library\\lib\\libprotobuf-lite.lib exit 1  # [win]
  - name: libprotobuf-static
    script: build_static.sh  # [unix]
    script: bld-static.bat  # [win]
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - cmake  # [win]
        - ninja  # [win]
        - autoconf  # [not win]
        - automake  # [not win]
        - libtool  # [not win]
        - pkg-config  # [not win]
        - unzip  # [not win]
        - make  # [not win]
      host:
        - zlib
        - {{ pin_subpackage('libprotobuf', exact=True) }}  # [not win]
      run:
        - zlib
        - {{ pin_subpackage('libprotobuf', exact=True) }}  # [not win]
      run_constrained:
        - libprotobuf <0a0  # [win]
    test:
      commands:
        - test -f ${PREFIX}/lib/libprotobuf.a  # [unix]
        - test -f ${PREFIX}/lib/libprotobuf-lite.a  # [unix]
        - test -f ${PREFIX}/lib/libprotoc.a  # [unix]
        - if exist %PREFIX%\\Library\\bin\\libprotoc.dll exit 1  # [win]
        - if not exist %PREFIX%\\Library\\lib\\libprotoc.lib exit 1  # [win]
        - if not exist %PREFIX%\\Library\\lib\\libprotobuf.lib exit 1  # [win]
        - if not exist %PREFIX%\\Library\\lib\\libprotobuf-lite.lib exit 1  # [win]

about:
  home: https://developers.google.com/protocol-buffers/
  license: BSD-3-Clause
  license_family: BSD
  license_file: LICENSE
  summary: Protocol Buffers - Google's data interchange format. C++ Libraries and protoc, the protobuf compiler.
  description: |
    Protocol buffers are Google's language-neutral,
    platform-neutral, extensible mechanism for serializing structured data-
    think XML, but smaller, faster, and simpler.
  doc_url: https://developers.google.com/protocol-buffers/
  doc_source_url: https://github.com/protocolbuffers/protobuf/releases

extra:
  recipe-maintainers:
    - dopplershift
    - jakirkham
    - ocefpaf
    - wesm
    - hajapy
    - xhochy
    - h-vetinari
